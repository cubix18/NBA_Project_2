with STG_SEASON_PLAYER_DATASET as (
    select * 
    from {{ source('STAGING_NBA_DATA', 'STG_SEASON_PLAYER_DATASET') }}
),

CLS_SEASON_PLAYER_DATASET as (
    SELECT 
        PLAYER_ID
        , INITCAP({{ normalize_name('NAME') }}) AS PLAYER_FULL_NAME
        , SEASON_ID AS PLAYER_SEASON_PLAYED
        , CAST(REPLACE(SPLIT(SEASON_ID, '-')[0], '"', '' ) AS NUMBER) AS START_OF_SEASON
        , CASE
            WHEN REPLACE(SPLIT(SEASON_ID, '-')[1], '"', '' ) > 40 THEN CAST(CONCAT('19','',REPLACE(SPLIT(SEASON_ID, '-')[1], '"', '' )) AS NUMBER)
            ELSE CAST(CONCAT('20','',REPLACE(SPLIT(SEASON_ID, '-')[1], '"', '' )) AS NUMBER)
        END AS END_OF_SEASON
        , TEAM_ABBREVIATION
        , PLAYER_AGE
        , GP AS PLAYER_GAMES_PLAYED
        , GS AS PLAYER_GAMES_STARTED
        , MIN AS PLAYER_MINUTES_PLAYED
        , FGM AS PLAYER_FG_MADE
        , FGA AS PLAYER_FG_ATTEMPTED
        , FG_PCT AS PLAYER_FG_PCT
        , FG3M AS PLAYER_3PT_MADE
        , FG3A AS PLAYER_3PT_ATTEMPTED
        , FG3_PCT AS PLAYER_3PT_PCT
        , FTM AS PLAYER_FT_MADE
        , FTA AS PLAYER_FT_ATTEMMPTED
        , FT_PCT AS PLAYER_FT_PCT
        , OREB AS PLAYER_OFF_REB
        , DREB AS PLAYER_DEF_REB
        , REB AS PLAYER_TOT_REB
        , AST AS PLAYER_ASSISTS
        , STL AS PLAYER_STEALS
        , BLK AS PLAYER_BLOCKS
        , TOV AS PLAYER_TOVERS
        , PF AS PLAYER_FOULS
        , PTS AS PLAYER_POINTS
        , 1 AS IS_VALID
        , TO_TIMESTAMP(CURRENT_TIMESTAMP ) AS LOAD_DATE
        , 'STAGING_NBA_DATA.STG_SEASON_PLAYER_DATASET' AS SOURCE_TABLE
    FROM STG_SEASON_PLAYER_DATASET
)

select * from CLS_SEASON_PLAYER_DATASET
