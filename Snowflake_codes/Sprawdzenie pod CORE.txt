WITH CTE AS (
SELECT 
    INITCAP(TRIM(DISPLAY_FIRST_LAST)) AS FULL_NAME
    , TO_DATE(BIRTHDATE) AS BIRTH_DATE
FROM NBA_DB.STAGING_NBA_DATA.STG_ALL_COMMON_PLAYER_INFO
),

CTF AS (
SELECT 
    INITCAP(CONCAT(FIRSTNAME, ' ', LASTNAME)) AS FULL_NAME
    , TO_DATE(BIRTHDATE) AS BIRTH_DATE
FROM NBA_DB.STAGING_NBA_DATA.STG_ALL_PLAYER_DETAILINFO 
), 

CTG1 AS(
SELECT MD5(CONCAT(FULL_NAME, BIRTH_DATE)), * FROM CTE
) ,

CTG2 AS(
SELECT MD5(CONCAT(FULL_NAME, BIRTH_DATE)), * FROM CTF
) 

SELECT * FROM CTG1
UNION 
SELECT * FROM CTG2;



SELECT DRAFT_YEAR, COUNT(DRAFT_YEAR) FROM NBA_DB.CLEANSE_NBA_DATA.CLS_ALL_COMMON_PLAYER_INFO
GROUP BY DRAFT_YEAR 
ORDER BY 1;


SELECT * FROM NBA_DB.CLEANSE_NBA_DATA.CLS_ALL_COMMON_PLAYER_INFO
WHERE PLAYER_FULL_NAME LIKE '%Lebron%';


with cte as (
SELECT * FROM NBA_DB.CLEANSE_NBA_DATA.CLS_SEASPLAY_PLAYER_STATS),

CTF AS (
SELECT 
    SEASON_YEAR
    , TEAM_NAME
    , PLAYER_FULL_NAME
    , GAME_TYPE
    , SUM((PLAYER_MINUTES_PLAYED * 60 + PLAYER_SECONDS_PLAYED)) AS PLAYER_TIME_PLAYED
    , SUM(PLAYER_FG_MADE) AS  PLAYER_FG_MADE
    , SUM(PLAYER_FG_ATTEMPTED) AS PLAYER_FG_ATTEMPTED
    , SUM(PLAYER_3PT_MADE) AS PLAYER_3PT_MADE
    , SUM(PLAYER_3PT_ATTEMPTED) AS PLAYER_3PT_ATTEMPTED
    , SUM(PLAYER_FT_MADE) AS PLAYER_FT_MADE
    , SUM(PLAYER_FT_ATTEMPTED) AS PLAYER_FT_ATTEMPTED
    , SUM(PLAYER_OFF_REB) AS PLAYER_OFF_REB
    , SUM(PLAYER_DEF_REB) AS PLAYER_DEF_REB
    , SUM(PLAYER_TOTAL_REB) AS PLAYER_TOTAL_REB
    , SUM(PLAYER_AST) AS PLAYER_AST
    , SUM(PLAYER_STL) AS PLAYER_STL
    , SUM(PLAYER_BLK) AS PLAYER_BLK
    , SUM(PLAYER_TOV) AS PLAYER_TOV
    , SUM(PLAYER_FOULS) AS PLAYER_FOULS
    , SUM(PLAYER_PTS) AS PLAYER_PTS
    , CAST(AVG(PLAYER_PLUS_MINUS) AS NUMBER) AS PLAYER_PLUS_MINUS
    , COUNT(PLAYER_SECONDS_PLAYED) AS PLAYER_GAME_PLAYED
    , 1 AS IS_VALID
    , TO_TIMESTAMP(CURRENT_TIMESTAMP ) AS LOAD_DATE
    , 'CLEANSE_NBA_DATA.CLS_SEASPLAY_PLAYER_STATS' AS SOURCE_TABLE
FROM CTE
WHERE PLAYER_SECONDS_PLAYED IS NOT NULL
GROUP BY SEASON_YEAR
    , TEAM_NAME
    , PLAYER_FULL_NAME
    , GAME_TYPE)

SELECT 
    SEASON_YEAR
    , TEAM_NAME
    , PLAYER_FULL_NAME
    , GAME_TYPE
    , PLAYER_FG_MADE
    , PLAYER_FG_ATTEMPTED
    , CASE
        WHEN PLAYER_FG_ATTEMPTED <> 0 THEN ROUND(PLAYER_FG_MADE / PLAYER_FG_ATTEMPTED, 4)
        ELSE 0
    END AS PLAYER_FG_PCT
    , PLAYER_3PT_MADE
    , PLAYER_3PT_ATTEMPTED
    , CASE
        WHEN PLAYER_3PT_ATTEMPTED <> 0 THEN ROUND(PLAYER_3PT_MADE / PLAYER_3PT_ATTEMPTED, 4)
        ELSE 0
    END AS PLAYER_3PT_PCT
    , PLAYER_FT_MADE
    , PLAYER_FT_ATTEMPTED
    , CASE
        WHEN PLAYER_FT_ATTEMPTED <> 0 THEN ROUND(PLAYER_FT_MADE / PLAYER_FT_ATTEMPTED, 4)
        ELSE 0
    END AS PLAYER_FT_PCT
    , PLAYER_OFF_REB
    , PLAYER_DEF_REB
    , PLAYER_TOTAL_REB
    , PLAYER_AST
    , PLAYER_STL
    , PLAYER_BLK
    , PLAYER_TOV
    , PLAYER_FOULS
    , PLAYER_PTS
    , ROUND(PLAYER_OFF_REB / PLAYER_GAME_PLAYED, 2) AS PLAYER_OFF_REB_AVG
    , ROUND(PLAYER_DEF_REB / PLAYER_GAME_PLAYED, 2) AS PLAYER_DEF_REB_AVG
    , ROUND(PLAYER_TOTAL_REB / PLAYER_GAME_PLAYED, 2) AS PLAYER_TOTAL_REB_AVG
    , ROUND(PLAYER_AST / PLAYER_GAME_PLAYED, 2) AS PLAYER_AST_AVG
    , ROUND(PLAYER_STL / PLAYER_GAME_PLAYED, 2) AS PLAYER_STL_AVG
    , ROUND(PLAYER_BLK / PLAYER_GAME_PLAYED, 2) AS PLAYER_BLK_AVG
    , ROUND(PLAYER_TOV / PLAYER_GAME_PLAYED, 2) AS PLAYER_TOV_AVG
    , ROUND(PLAYER_FOULS / PLAYER_GAME_PLAYED, 2) AS PLAYER_FOULS_AVG
    , ROUND(PLAYER_PTS / PLAYER_GAME_PLAYED, 2) AS PLAYER_PTS_AVG
    , PLAYER_PLUS_MINUS
    , PLAYER_GAME_PLAYED
    , 1 AS IS_VALID
    , TO_TIMESTAMP(CURRENT_TIMESTAMP ) AS LOAD_DATE
    , 'CLEANSE_NBA_DATA.CLS_SEASPLAY_PLAYER_STATS' AS SOURCE_TABLE
FROM CTF;

WITH CTE AS (
SELECT DISTINCT(PLAYER_FULL_NAME) AS PLAYER_FULL_NAME FROM NBA_DB.CORE_NBA_DATA.CO_SEASPLAY_PLAYER_STATS
)

SELECT PLAYER_FULL_NAME, ROW_NUMBER() OVER (PARTITION BY PLAYER_FULL_NAME ORDER BY PLAYER_FULL_NAME) AS RN FROM CTE
ORDER BY 1;

-----------------------------------------------------------------------------------------------------------------------------------

SELECT * FROM NBA_DB.CORE_NBA_DATA.CO_SEASPLAY_PLAYER_STATS
ORDER BY SEASON_YEAR, PLAYER_FULL_NAME;


SELECT * FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_STATS PST
LEFT JOIN NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY PLH ON PST.PLAYER_NAME = PLH.PLAYER_FULL_NAME
WHERE PLH.PLAYER_FULL_NAME IS NULL;


WITH CTE AS (
    SELECT 
        * 
    FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY
),

CTF AS (
    SELECT 
        * 
    FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_STATS
),

CTG AS (
SELECT 
    CASE 
        WHEN PLH.PLAYER_FULL_NAME IS NOT NULL THEN PLH.PLAYER_FULL_NAME
        ELSE PST.PLAYER_NAME
    END AS PLAYER_FULL_NAME
    , CASE
        WHEN PLH.DRAFT_YEAR IS NOT NULL THEN PLH.DRAFT_YEAR
        ELSE PST.DRAFT_YEAR
    END AS DRAFT_YEAR
    , CASE
        WHEN PLH.OVERALL_PICK IS NOT NULL THEN PLH.OVERALL_PICK
        ELSE PST.DRAFT_NUMBER
    END AS DRAFT_NUMBER
    , CASE
        WHEN PLH.DRAFT_TYPE IS NOT NULL THEN PLH.DRAFT_TYPE
        ELSE 'Unknown'
    END AS DRAFT_TYPE
    , CASE
        WHEN PLH.TEAM_NAME IS NOT NULL THEN PLH.TEAM_NAME
        ELSE PST.TEAM_ABREVIATION
    END AS TEAM_NAME
    , CASE
        WHEN PLH.TEAM_ABBREVIATION IS NOT NULL THEN PLH.TEAM_ABBREVIATION
        ELSE PST.TEAM_ABREVIATION
    END AS TEAM_ABBREVIATION
    , CASE
        WHEN PLH.TEAM_NICKNAME IS NOT NULL THEN PLH.TEAM_NICKNAME
        ELSE 'Unknown'
    END AS TEAM_NICKNAME
    , CASE
        WHEN PLH.TEAM_CITY IS NOT NULL THEN PLH.TEAM_CITY
        ELSE 'Unknown'
    END AS TEAM_CITY
    , CASE
        WHEN PLH.TEAM_ORGANIZTION IS NOT NULL THEN PLH.TEAM_ORGANIZTION
        ELSE PST.COLLEGE_NAME
    END AS COLLEGE_OR_TEAM_NAME
    , CASE
        WHEN PLH.TEAM_ORGANIZTION_TYPE IS NOT NULL THEN PLH.TEAM_ORGANIZTION_TYPE
        ELSE 'Unknown'
    END AS TEAM_ORGANIZTION_TYPE
    , PST.YEARS_PLAYED
    , PST.GAMES_PLAYED
    , PST.TOTAL_MINUTES_PLAYED
    , PST.TOTAL_POINTS
    , PST.TOTAL_REBOUNDS
    , PST.TOTAL_ASSISTS
    , PST.AVG_FG
    , PST.AVG_3PTM
    , PST.AVG_FT
    , PST.WIN_SHARED
    , PST."BOX +/-"
    , PST.VORP
    , PST.POINTS_PER_GAME
    , PST.REBOUNDS_PER_GAME
    , PST.ASSISTS_PER_GAME
    , 1 AS IS_VALID
     , TO_TIMESTAMP(CURRENT_TIMESTAMP ) AS LOAD_DATE
    , 'NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY' AS SOURCE_TABLE_1
    , 'NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_STATS' AS SOURCE_TABLE_2
FROM CTE PLH
FULL JOIN CTF PST 
ON PST.DRAFT_YEAR = PLH.DRAFT_YEAR AND PST.DRAFT_NUMBER = PLH.OVERALL_PICK
)

SELECT * FROM CTG;


SELECT * FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY
ORDER BY 2;


with cte as (
SELECT distinct(draft_year) as draft_year, lag(draft_year, 1) over(order by draft_year) as lag FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY
)

select *, draft_year - lag from cte 
where draft_year <> lag
order by 1,2;

-- NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_HISTORY - Nieciągłość w 2014 roku,  1955, 1966


SELECT * FROM NBA_DB.CLEANSE_NBA_DATA.CLS_DRAFT_PLAYER_COMBINE_STATS;


/*
Powtarzający się gracze
Marcus Williams
Justin Jackson
Dee Brown
Corey Brewer
Marcus Thornton